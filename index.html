<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ ¸å¿ƒï¼šè§£å†³Bç«™å›¾ç‰‡é˜²ç›—é“¾ï¼Œå¿…åŠ  -->
    <meta name="referrer" content="no-referrer">
    <title>æˆ‘çš„è½»Bç«™</title>
    <!-- å›½å†…å¯è®¿é—®çš„CDNèµ„æº -->
    <script src="https://cdn.tailwindcss.cn"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.net/font-awesome/6.4.0/css/all.min.css">
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FB7299">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Tailwindé…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bilibili: '#FB7299',
                        bilibili_dark: '#F1497E',
                        gray_bg: '#F4F4F4',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
        }
    </style>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* å›¾ç‰‡å®¹å™¨å…¼å®¹å†™æ³•ï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º */
        .video-cover {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            overflow: hidden;
            border-radius: 10px 10px 0 0;
        }
        .video-cover img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* åˆ·æ–°æŒ‰é’®åŠ¨ç”» */
        .refresh-icon.loading {
            animation: rotate 0.6s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* æˆåŠŸæç¤º */
        .success-tip {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .success-tip.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray_bg min-h-screen pb-20 overflow-x-hidden">
    <!-- åˆ·æ–°æˆåŠŸæç¤º -->
    <div class="success-tip fixed top-14 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-1.5 rounded-full text-xs z-50" id="successTip">
        åˆ·æ–°æˆåŠŸï¼Œå·²æ›´æ–°æœ€æ–°çƒ­é—¨æ•°æ®
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-40 bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex items-center gap-2 flex-wrap">
            <div class="w-9 h-9 bg-bilibili rounded-lg flex items-center justify-center text-white font-bold text-lg">è½»</div>
            <h1 class="text-lg font-bold">æˆ‘çš„è½»Bç«™</h1>
            <span class="text-xs text-gray-500">ç¼–ç¨‹å°ç™½</span>
            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">v1.0</span>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 py-3">
        <!-- é¦–é¡µå†…å®¹ -->
        <section id="homePage" class="block">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    ğŸ”¥ ä»Šæ—¥çƒ­é—¨
                </h2>
                <button id="refreshBtn" class="text-sm text-bilibili flex items-center gap-1 px-2 py-1 rounded hover:bg-bilibili/5 transition-all">
                    <span class="refresh-icon"><i class="fas fa-sync-alt"></i></span>
                    <span class="refresh-text">åˆ·æ–°</span>
                </button>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingBox" class="py-20 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>æ­£åœ¨åŠ è½½çƒ­é—¨å†…å®¹...</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="errorBox" class="py-20 text-center hidden">
                <i class="fas fa-exclamation-circle text-3xl text-bilibili mb-2"></i>
                <p class="text-gray-600 mb-2">ç½‘ç»œåŠ è½½å¤±è´¥(å¯ç¨ååˆ·æ–°)</p>
                <button id="retryBtn" class="px-4 py-1.5 bg-bilibili text-white rounded-full text-sm hover:bg-bilibili_dark transition-all">ç«‹å³åˆ·æ–°</button>
            </div>

            <!-- è§†é¢‘åˆ—è¡¨ -->
            <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
        </section>

        <!-- å…¶ä»–Tabå ä½ -->
        <section id="searchPage" class="hidden py-20 text-center text-gray-500">
            <i class="fas fa-search text-3xl mb-2"></i>
            <h3>æœç´¢ç»“æœ</h3>
            <p class="my-2">åŠŸèƒ½å¼€å‘ä¸­...</p>
        </section>
        <section id="dynamicPage" class="hidden py-20 text-center text-gray-500">
            <i class="fas fa-bell text-3xl mb-2"></i>
            <h3>åŠ¨æ€åŠŸèƒ½å¼€å‘ä¸­...</h3>
        </section>
        <section id="minePage" class="hidden py-20 text-center text-gray-500">
            <i class="fas fa-user text-3xl mb-2"></i>
            <h3>æˆ‘çš„ç©ºé—´å¼€å‘ä¸­...</h3>
        </section>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-50">
        <div class="max-w-lg mx-auto flex justify-around items-center py-3">
            <button data-page="homePage" class="nav-tab flex flex-col items-center gap-1 text-bilibili px-3 py-1 rounded">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs">é¦–é¡µ</span>
            </button>
            <button data-page="searchPage" class="nav-tab flex flex-col items-center gap-1 text-gray-400 px-3 py-1 rounded">
                <i class="fas fa-search text-xl"></i>
                <span class="text-xs">æœç´¢</span>
            </button>
            <button data-page="dynamicPage" class="nav-tab flex flex-col items-center gap-1 text-gray-400 px-3 py-1 rounded">
                <i class="fas fa-bell text-xl"></i>
                <span class="text-xs">åŠ¨æ€</span>
            </button>
            <button data-page="minePage" class="nav-tab flex flex-col items-center gap-1 text-gray-400 px-3 py-1 rounded">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs">æˆ‘çš„</span>
            </button>
        </div>
    </nav>

    <!-- æ ¸å¿ƒJSé€»è¾‘ -->
    <script>
        // å…¨å±€å…ƒç´ 
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshText = refreshBtn.querySelector('.refresh-text');
        const refreshIcon = refreshBtn.querySelector('.refresh-icon');
        const retryBtn = document.getElementById('retryBtn');
        const loadingBox = document.getElementById('loadingBox');
        const errorBox = document.getElementById('errorBox');
        const videoList = document.getElementById('videoList');
        const successTip = document.getElementById('successTip');
        const navTabs = document.querySelectorAll('.nav-tab');
        const allPages = document.querySelectorAll('section');

        // åŒä»£ç†å…œåº•ï¼Œå›½å†…å¯è®¿é—®
        const PROXY_LIST = [
            'https://api.allorigins.win/raw?url=',
            'https://cors.sh/'
        ];
        let proxyIndex = 0;
        // Bç«™çƒ­é—¨APIï¼ŒåŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
        const BILIBILI_API = 'https://api.bilibili.com/x/web-interface/ranking/v2?rid=0&type=all';
        let abortController = null;
        // å›¾ç‰‡åŠ è½½å¤±è´¥å…œåº•å ä½å›¾
        const PLACEHOLDER_IMG = 'https://picsum.photos/480/300?grayscale&blur=2';

        // å·¥å…·å‡½æ•°
        function formatNum(num) {
            if (!num) return '0';
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'äº¿';
            if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
            return num.toString();
        }
        function formatDuration(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, '0')}`;
        }
        function showSuccess() {
            successTip.classList.add('show');
            setTimeout(() => successTip.classList.remove('show'), 1500);
        }

        // æ ¸å¿ƒåˆ·æ–°+æ•°æ®è¯·æ±‚å‡½æ•°
        async function refreshHotData() {
            // ç‚¹å‡»ç¬é—´åé¦ˆ
            refreshBtn.disabled = true;
            refreshText.textContent = 'åˆ·æ–°ä¸­...';
            refreshIcon.classList.add('loading');
            // ä¸­æ–­ä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¯·æ±‚
            if (abortController) abortController.abort();
            abortController = new AbortController();

            // é‡ç½®é¡µé¢çŠ¶æ€
            videoList.innerHTML = '';
            videoList.classList.add('hidden');
            errorBox.classList.add('hidden');
            loadingBox.classList.remove('hidden');

            try {
                // å‘èµ·å…¨æ–°è¯·æ±‚ï¼ŒåŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
                const currentProxy = PROXY_LIST[proxyIndex];
                const fullApi = `${BILIBILI_API}&t=${Date.now()}`;
                const res = await fetch(currentProxy + encodeURIComponent(fullApi), {
                    signal: abortController.signal,
                    timeout: 10000
                });
                if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
                
                const data = await res.json();
                if (data.code !== 0 || !data.data?.list) throw new Error('æ•°æ®è·å–å¤±è´¥');

                // æ¸²æŸ“è§†é¢‘åˆ—è¡¨+å›¾ç‰‡ï¼ŒåŠ åŠ è½½å…œåº•
                const videoData = data.data.list;
                videoList.innerHTML = videoData.map(item => {
                    // å¤„ç†å›¾ç‰‡é“¾æ¥ï¼šå¼ºåˆ¶https+è£å‰ª+æ ¼å¼ä¼˜åŒ–
                    const imgUrl = item.pic.replace('http://', 'https://') + '@480w_300h_1c.webp';
                    return `
                        <a href="https://www.bilibili.com/video/${item.bvid}" target="_blank" class="bg-white rounded-xl overflow-hidden hover:shadow-lg hover:-translate-y-1 transition-all">
                            <div class="video-cover">
                                <img 
                                    src="${imgUrl}" 
                                    alt="${item.title}" 
                                    loading="lazy"
                                    onerror="this.src='${PLACEHOLDER_IMG}'"
                                >
                                <span class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-1.5 py-0.5 rounded">${formatDuration(item.duration)}</span>
                            </div>
                            <div class="p-3">
                                <h3 class="font-medium text-sm line-clamp-2 mb-2 h-10">${item.title}</h3>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span><i class="fas fa-play mr-1"></i>${formatNum(item.stat.view)}</span>
                                    <span><i class="fas fa-comment-dots mr-1"></i>${formatNum(item.stat.danmaku)}</span>
                                </div>
                                <div class="mt-2 text-xs text-gray-400 truncate">
                                    <img src="${item.owner.face.replace('http://','https://')}@32w_32h.webp" alt="${item.owner.name}" class="w-4 h-4 rounded-full inline-block mr-1" onerror="this.src='${PLACEHOLDER_IMG}'" loading="lazy">
                                    ${item.owner.name}
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');

                // åˆ·æ–°æˆåŠŸ
                loadingBox.classList.add('hidden');
                videoList.classList.remove('hidden');
                showSuccess();
                proxyIndex = 0;

            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error('åˆ·æ–°å¤±è´¥ï¼š', err);
                // è‡ªåŠ¨åˆ‡æ¢ä»£ç†é‡è¯•
                if (proxyIndex < PROXY_LIST.length - 1) {
                    proxyIndex++;
                    refreshBtn.disabled = false;
                    refreshHotData();
                    return;
                }
                // æ˜¾ç¤ºé”™è¯¯
                loadingBox.classList.add('hidden');
                errorBox.classList.remove('hidden');
            } finally {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshText.textContent = 'åˆ·æ–°';
                refreshIcon.classList.remove('loading');
                abortController = null;
            }
        }

        // äº‹ä»¶ç»‘å®š
        refreshBtn.addEventListener('click', refreshHotData);
        retryBtn.addEventListener('click', refreshHotData);
        // Tabåˆ‡æ¢
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetPage = tab.getAttribute('data-page');
                allPages.forEach(page => page.classList.add('hidden'));
                document.getElementById(targetPage).classList.remove('hidden');
                navTabs.forEach(t => t.classList.remove('text-bilibili'));
                tab.classList.add('text-bilibili');
            });
        });

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            refreshHotData();
            // æ³¨å†ŒPWAæœåŠ¡
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            }
        });
    </script>
</body>
</html>
